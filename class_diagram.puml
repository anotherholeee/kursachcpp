@startuml
!theme plain

skinparam linetype ortho
skinparam classRoundCorner 0
skinparam classBorderThickness 2
skinparam classFontName "Times New Roman"
skinparam classFontSize 14
skinparam classFontStyle normal
skinparam classFontColor black
skinparam classAttributeIconSize 0
skinparam classBorderColor black
skinparam classBackgroundColor white
skinparam classArrowColor black
skinparam classAbstractFontStyle italic
skinparam classAbstractFontColor black
skinparam classAbstractUnderline true
skinparam inheritanceArrowColor black

hide circle

' Базовые классы и исключения
class TransportException {
    - message : string
    + TransportException(msg : string)
    + {virtual} ~TransportException()
    + what() : const char*
}

class InputException {
    + InputException(msg : string)
    + {virtual} ~InputException()
}

class FileException {
    + FileException(filename : string, operation : string)
    + FileException(msg : string)
    + {virtual} ~FileException()
}

class ContainerException {
    + ContainerException(msg : string)
    + {virtual} ~ContainerException()
}

' Иерархия транспортных средств
class Vehicle {
    # type : string
    # model : string
    # licensePlate : string
    + Vehicle(t : string, m : string, lp : string)
    + {virtual} ~Vehicle()
    + getInfo() : string
    + getType() : string
    + getModel() : string
    + getLicensePlate() : string
    + {virtual} serialize() : string
    + {static} deserialize(data : string) : Vehicle
}

class FuelTransport {
    # capacity : int
    # fuelType : string
    + FuelTransport(t : string, m : string, lp : string, cap : int, fuel : string)
    + {virtual} ~FuelTransport()
    + getCapacity() : int
    + setCapacity(cap : int) : void
    + getFuelType() : string
    + setFuelType(fuel : string) : void
    + serialize() : string
}

class ElectricTransport {
    # capacity : int
    # voltage : double
    + ElectricTransport(t : string, m : string, lp : string, cap : int, volt : double)
    + {virtual} ~ElectricTransport()
    + getCapacity() : int
    + setCapacity(cap : int) : void
    + getVoltage() : double
    + setVoltage(volt : double) : void
    + serialize() : string
}

class Bus {
    + Bus(m : string, lp : string, cap : int, fuel : string)
    + {virtual} ~Bus()
}

class Tram {
    + Tram(m : string, lp : string, cap : int, volt : double)
    + {virtual} ~Tram()
}

class Trolleybus {
    + Trolleybus(m : string, lp : string, cap : int, volt : double)
    + {virtual} ~Trolleybus()
}

' Классы данных
class Driver {
    - firstName : string
    - lastName : string
    - middleName : string
    - category : string
    + Driver(fname : string, lname : string, mname : string, cat : string)
    + ~Driver()
    + getFullName() : string
    + getFirstName() : string
    + getLastName() : string
    + getMiddleName() : string
    + getCategory() : string
    + setCategory(cat : string) : void
    + operator==(other : Driver) : bool
    + serialize() : string
    + {static} deserialize(data : string) : Driver
}

class Stop {
    - id : int
    - name : string
    + Stop(stopId : int, stopName : string)
    + ~Stop()
    + getId() : int
    + getName() : string
    + operator==(other : Stop) : bool
    + serialize() : string
    + {static} deserialize(data : string) : Stop
}

class Time {
    - hours : int
    - minutes : int
    + Time(h : int, m : int)
    + Time(timeStr : string)
    + ~Time()
    + getTotalMinutes() : int
    + getHours() : int
    + getMinutes() : int
    + operator<(other : Time) : bool
    + operator<=(other : Time) : bool
    + operator>(other : Time) : bool
    + operator>=(other : Time) : bool
    + operator==(other : Time) : bool
    + operator!=(other : Time) : bool
    + operator+(minutesToAdd : int) : Time
    + operator-(minutesToSubtract : int) : Time
    + operator-(other : Time) : int
    + {friend} operator<<(os : ostream&, time : Time) : ostream&
    + {friend} operator>>(is : istream&, time : Time&) : istream&
    + serialize() : string
    + {static} deserialize(data : string) : Time
}

class Route {
    - number : int
    - vehicleType : string
    - startStop : string
    - endStop : string
    - allStops : List
    - weekDays : set
    + Route(num : int, vType : string, stops : List, days : set)
    + ~Route()
    + containsStop(stop : string) : bool
    + getStopPosition(stop : string) : int
    + isStopBefore(stopA : string, stopB : string) : bool
    + getNumber() : int
    + getVehicleType() : string
    + getStartStop() : string
    + getEndStop() : string
    + getAllStops() : List
    + getWeekDays() : set
    + operatesOnDay(day : int) : bool
    + serialize() : string
    + {static} deserialize(data : string) : Route
}

class Trip {
    - tripId : int
    - route : Route
    - vehicle : Vehicle
    - driver : Driver
    - startTime : Time
    - schedule : map
    - weekDay : int
    + Trip(id : int, r : Route, v : Vehicle, d : Driver, start : Time, day : int)
    + ~Trip()
    + setArrivalTime(stop : string, time : Time) : void
    + getArrivalTime(stop : string) : Time
    + hasStop(stop : string) : bool
    + getTripId() : int
    + getRoute() : Route
    + getVehicle() : Vehicle
    + getDriver() : Driver
    + getStartTime() : Time
    + getSchedule() : map
    + getWeekDay() : int
    + getEstimatedEndTime() : Time
    + serialize() : string
    + {static} deserialize(data : string, system : TransportSystem*) : Trip
}

class Journey {
    - trips : List
    - transferPoints : List
    - startTime : Time
    - endTime : Time
    - transferCount : int
    + Journey(tripList : List, transfers : List, start : Time, end : Time)
    + ~Journey()
    + getTotalDuration() : int
    + getTransferCount() : int
    + getStartTime() : Time
    + getEndTime() : Time
    + getTrips() : List
    + getTransferPoints() : List
    + display() : void
}

' Контейнер List
class List<T> <<template>> {
    - head : Node*
    - tail : Node*
    - size_ : size_t
    + List()
    + List(other : List)
    + List(first : InputIt, last : InputIt)
    + operator=(other : List) : List&
    + ~List()
    + push_back(value : T) : void
    + push_back(value : T&&) : void
    + emplace_back(args : Args...) : void
    + erase(it : Iterator) : Iterator
    + erase(first : Iterator, last : Iterator) : void
    + operator[](index : size_t) : T&
    + operator[](index : size_t) : const T&
    + front() : T&
    + front() : const T&
    + back() : T&
    + back() : const T&
    + size() : size_t
    + empty() : bool
    + clear() : void
    + sort(comp : Compare) : void
    + reverse() : void
    + begin() : Iterator
    + end() : Iterator
    + begin() : const Iterator
    + end() : const Iterator
    --
    + Iterator
}

' Паттерн Command
' Примечание: Конкретные команды (AddRouteCommand, RemoveRouteCommand, AddTripCommand и т.д.)
' скрыты для упрощения диаграммы. Все они наследуются от Command и реализуют execute(), undo(), getDescription()
abstract class Command {
    + {virtual} ~Command()
    + {abstract} execute() : void
    + {abstract} undo() : void
    + {abstract} getDescription() : string
}

class CommandHistory {
    - history : List
    - currentIndex : size_t
    - MAX_HISTORY_SIZE : size_t
    + CommandHistory()
    + ~CommandHistory()
    + executeCommand(cmd : Command) : void
    + canUndo() : bool
    + undo() : void
    + canRedo() : bool
    + redo() : void
    + clear() : void
    + getLastCommandDescription() : string
    + getNextCommandDescription() : string
}

' Паттерн Strategy (алгоритмы)
abstract class IAlgorithm {
    + {virtual} ~IAlgorithm()
    + {abstract} execute() : void
    + {abstract} getDescription() : string
}

class Algorithm<T> <<template>> {
    # system : TransportSystem*
    # algorithmObject : T
    + Algorithm(sys : TransportSystem*, obj : T)
    + Algorithm(sys : TransportSystem*, obj : T&&)
    + Algorithm(sys : TransportSystem*)
    + {virtual} ~Algorithm()
    + execute() : void
    + getDescription() : string
    + setSystem(sys : TransportSystem*) : void
    + executeAlgorithm(args : Args...) : auto
    + operator()(args : Args...) : auto
    + getAlgorithm() : T&
}

class TemplateAlgorithm<T> <<template>> {
    # algorithmObject : T
    + TemplateAlgorithm(obj : T)
    + TemplateAlgorithm(obj : T&&)
    + TemplateAlgorithm()
    + TemplateAlgorithm(args : Args...)
    + execute(args : Args...) : auto
    + operator()(args : Args...) : auto
    + getAlgorithm() : T&
}

class BaseAlgorithm {
    # system : TransportSystem*
    + BaseAlgorithm(sys : TransportSystem*)
    + {virtual} ~BaseAlgorithm()
    + execute() : void
    + getDescription() : string
    + setSystem(sys : TransportSystem*) : void
}

abstract class PathFindingAlgorithm {
    + PathFindingAlgorithm(sys : TransportSystem*)
    + {virtual} ~PathFindingAlgorithm()
    + {abstract} findPath(start : string, end : string, departureTime : Time) : List
    + execute() : void
    + getDescription() : string
}

class BFSAlgorithm {
    - maxTransfers : int
    + BFSAlgorithm(sys : TransportSystem*, maxTransfers : int)
    + {virtual} ~BFSAlgorithm()
    + findPath(start : string, end : string, departureTime : Time) : List
    + execute() : void
    + getDescription() : string
}

class FastestPathAlgorithm {
    + FastestPathAlgorithm(sys : TransportSystem*)
    + {virtual} ~FastestPathAlgorithm()
    + findPath(start : string, end : string, departureTime : Time) : List
    + execute() : void
    + getDescription() : string
}

class MinimalTransfersAlgorithm {
    + MinimalTransfersAlgorithm(sys : TransportSystem*)
    + {virtual} ~MinimalTransfersAlgorithm()
    + findPath(start : string, end : string, departureTime : Time) : List
    + execute() : void
    + getDescription() : string
}

class ArrivalTimeCalculationAlgorithm {
    + ArrivalTimeCalculationAlgorithm(sys : TransportSystem*)
    + {virtual} ~ArrivalTimeCalculationAlgorithm()
    + calculateArrivalTimes(tripId : int, averageSpeed : double) : void
    + execute() : void
    + getDescription() : string
}

class RouteSearchAlgorithm {
    + RouteSearchAlgorithm(sys : TransportSystem*)
    + {virtual} ~RouteSearchAlgorithm()
    + findRoutes(stopA : string, stopB : string) : List
    + execute() : void
    + getDescription() : string
}

' Основные классы системы
class DataManager {
    - dataDirectory : string
    + DataManager(dir : string)
    + ~DataManager()
    + saveAllData(system : TransportSystem&) : void
    + loadAllData(system : TransportSystem&) : void
    - saveStops(system : TransportSystem&) : void
    - saveVehicles(system : TransportSystem&) : void
    - saveDrivers(system : TransportSystem&) : void
    - saveRoutes(system : TransportSystem&) : void
    - saveTrips(system : TransportSystem&) : void
    - saveAdminCredentials(system : TransportSystem&) : void
    - loadStops(system : TransportSystem&) : void
    - loadVehicles(system : TransportSystem&) : void
    - loadDrivers(system : TransportSystem&) : void
    - loadRoutes(system : TransportSystem&) : void
    - loadTrips(system : TransportSystem&) : void
    - loadAdminCredentials(system : TransportSystem&) : void
}

class DriverSchedule {
    - driverTrips : unordered_map
    - MAX_WORKING_HOURS : int
    + DriverSchedule()
    + ~DriverSchedule()
    + assignTripToDriver(driver : Driver, trip : Trip) : void
    + removeTripFromDriver(driver : Driver, tripId : int) : void
    + isDriverAvailable(driver : Driver, startTime : Time, endTime : Time) : bool
    + checkWorkingHoursCompliance(driver : Driver) : bool
    + getDriverTrips(driver : Driver) : List
    + getTotalWorkingMinutes(driver : Driver) : int
}

class JourneyPlanner {
    - system : TransportSystem*
    - bfsAlgorithm : BFSAlgorithm
    - fastestAlgorithm : FastestPathAlgorithm
    - minimalTransfersAlgorithm : MinimalTransfersAlgorithm
    + JourneyPlanner(sys : TransportSystem*)
    + ~JourneyPlanner()
    + findJourneysWithTransfers(startStop : string, endStop : string, departureTime : Time, maxTransfers : int) : List
    + findAllJourneysWithTransfers(startStop : string, endStop : string, maxTransfers : int) : List
    + findFastestJourney(startStop : string, endStop : string, departureTime : Time) : Journey
    + findJourneyWithLeastTransfers(startStop : string, endStop : string, departureTime : Time) : Journey
    + displayJourney(journey : Journey) : void
}

class TransportSystem {
    - routes : List
    - trips : List
    - vehicles : List
    - drivers : List
    - stops : List
    - stopIdToName : unordered_map
    - adminCredentials : unordered_map
    - journeyPlanner : JourneyPlanner
    - driverSchedule : DriverSchedule
    - dataManager : DataManager
    - commandHistory : CommandHistory
    - arrivalTimeAlgorithm : ArrivalTimeCalculationAlgorithm
    - routeSearchAlgorithm : RouteSearchAlgorithm
    + TransportSystem()
    + ~TransportSystem()
    + canUndo() : bool
    + undo() : void
    + canRedo() : bool
    + redo() : void
    + getLastCommandDescription() : string
    + getNextCommandDescription() : string
    + authenticateAdmin(username : string, password : string) : bool
    + addAdmin(username : string, password : string) : void
    + getAdminCredentials() : unordered_map
    + setAdminCredentials(creds : unordered_map) : void
    + saveData() : void
    + loadData() : void
    + findRoutes(stopA : string, stopB : string) : List
    + getStopTimetable(stopId : int, startTime : Time, endTime : Time) : void
    + getStopTimetableAll(stopName : string) : void
    + calculateArrivalTimes(tripId : int, averageSpeed : double) : void
    + getArrivalTimeAlgorithm() : ArrivalTimeCalculationAlgorithm*
    + getRouteSearchAlgorithm() : RouteSearchAlgorithm*
    + addRoute(route : Route) : void
    + addTrip(trip : Trip) : void
    + addVehicle(vehicle : Vehicle) : void
    + addDriver(driver : Driver) : void
    + addStop(stop : Stop) : void
    + removeRoute(routeNumber : int) : void
    + removeTrip(tripId : int) : void
    + displayAllRoutes() : void
    + displayAllTrips() : void
    + displayAllVehicles() : void
    + displayAllStops() : void
    + getTrips() : List
    + getRoutes() : List
    + getVehicles() : List
    + getStops() : List
    + getDrivers() : List
    + getJourneyPlanner() : JourneyPlanner&
    + getDriverSchedule() : DriverSchedule&
    + findDriverByName(firstName : string, lastName : string, middleName : string) : Driver
    + findVehicleByLicensePlate(licensePlate : string) : Vehicle
    + findRouteByNumber(number : int) : Route
    + getTripsThroughStop(stopName : string) : List
    + getStopNameById(id : int) : string
    + getRouteByNumber(number : int) : Route
    + getTripById(id : int) : Trip
    + getVehicleByLicensePlate(licensePlate : string) : Vehicle
    + getStopById(id : int) : Stop
    + addRouteDirect(route : Route) : void
    + removeRouteDirect(routeNumber : int) : void
    + addTripDirect(trip : Trip) : void
    + removeTripDirect(tripId : int) : void
    + addVehicleDirect(vehicle : Vehicle) : void
    + removeVehicleDirect(licensePlate : string) : void
    + addStopDirect(stop : Stop) : void
    + removeStopDirect(stopId : int) : void
    + addDriverDirect(driver : Driver) : void
    + removeDriverDirect(driver : Driver) : void
}

' Наследование
TransportException <|-- InputException
TransportException <|-- FileException
TransportException <|-- ContainerException

Vehicle <|-- FuelTransport
Vehicle <|-- ElectricTransport
FuelTransport <|-- Bus
ElectricTransport <|-- Tram
ElectricTransport <|-- Trolleybus


IAlgorithm <|-- Algorithm
IAlgorithm <|-- BaseAlgorithm
BaseAlgorithm <|-- PathFindingAlgorithm
BaseAlgorithm <|-- ArrivalTimeCalculationAlgorithm
BaseAlgorithm <|-- RouteSearchAlgorithm
PathFindingAlgorithm <|-- BFSAlgorithm
PathFindingAlgorithm <|-- FastestPathAlgorithm
PathFindingAlgorithm <|-- MinimalTransfersAlgorithm

' Композиция и агрегация
TransportSystem *-- JourneyPlanner
TransportSystem *-- DriverSchedule
TransportSystem *-- DataManager
TransportSystem *-- CommandHistory
TransportSystem *-- ArrivalTimeCalculationAlgorithm
TransportSystem *-- RouteSearchAlgorithm
TransportSystem "1" *-- "0..*" Route : routes
TransportSystem "1" *-- "0..*" Trip : trips
TransportSystem "1" *-- "0..*" Vehicle : vehicles
TransportSystem "1" *-- "0..*" Driver : drivers
TransportSystem "1" *-- "0..*" Stop : stops

Trip "1" --> "1" Route : route
Trip "1" --> "1" Vehicle : vehicle
Trip "1" --> "1" Driver : driver
Trip "1" --> "1" Time : startTime
Trip "1" --> "0..*" Time : schedule

Journey "1" --> "0..*" Trip : trips
Journey "1" --> "1" Time : startTime
Journey "1" --> "1" Time : endTime


JourneyPlanner *-- BFSAlgorithm
JourneyPlanner *-- FastestPathAlgorithm
JourneyPlanner *-- MinimalTransfersAlgorithm

CommandHistory "1" *-- "0..*" Command : history

DriverSchedule "1" --> "0..*" Driver : driverTrips
DriverSchedule "1" --> "0..*" Trip : trips


BFSAlgorithm --> TransportSystem
FastestPathAlgorithm --> TransportSystem
MinimalTransfersAlgorithm --> TransportSystem
ArrivalTimeCalculationAlgorithm --> TransportSystem
RouteSearchAlgorithm --> TransportSystem
JourneyPlanner --> TransportSystem
DataManager --> TransportSystem
BaseAlgorithm --> TransportSystem

' Использование List контейнера
PathFindingAlgorithm ..> List : uses
BFSAlgorithm ..> List : uses
FastestPathAlgorithm ..> List : uses
MinimalTransfersAlgorithm ..> List : uses
RouteSearchAlgorithm ..> List : uses
Journey ..> List : uses
Route ..> List : uses
TransportSystem ..> List : uses
CommandHistory ..> List : uses
DriverSchedule ..> List : uses
JourneyPlanner ..> List : uses

@enduml
